!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("leaflet"),require("mars2d")):"function"==typeof define&&define.amd?define(["exports","leaflet","mars2d"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self)["mars2d-esri"]={},t.L,t.mars2d)}(this,function(t,e,i){"use strict";function s(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}function o(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach(function(i){if("default"!==i){var s=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,s.get?s:{enumerable:!0,get:function(){return t[i]}})}}),e.default=t,e}var r=s(e),n=o(i),a="3.0.18";const l=window.XMLHttpRequest&&"withCredentials"in new window.XMLHttpRequest,h=""===document.documentElement.style.pointerEvents,p={cors:l,pointerEvents:h},u={attributionWidthOffset:55};let c=0;function d(t){let e="";t.f=t.f||"json";for(const i in t)if(Object.hasOwn(t,i)){const s=t[i],o=Object.prototype.toString.call(s);let r;e.length&&(e+="&"),r="[object Array]"===o?"[object Object]"===Object.prototype.toString.call(s[0])?JSON.stringify(s):s.join(","):"[object Object]"===o?JSON.stringify(s):"[object Date]"===o?s.valueOf():s,e+=`${encodeURIComponent(i)}=${encodeURIComponent(r)}`}return e.replaceAll("'","%27")}function m(t,i){const s=new window.XMLHttpRequest;return s.onerror=function(){s.onreadystatechange=e.Util.falseFn,t.call(i,{error:{code:500,message:"XMLHttpRequest error"}},null)},s.onreadystatechange=function(){let o,r;if(4===s.readyState){try{o=JSON.parse(s.responseText)}catch(t){o=null,r={code:500,message:"Could not parse response as JSON. This could also be caused by a CORS or XMLHttpRequest error."}}!r&&o.error&&(r=o.error,o=null),s.onerror=e.Util.falseFn,t.call(i,r,o)}},s.ontimeout=function(){this.onerror()},s}function y(t,e,i,s){const o=m(i,s);return o.open("POST",t),null!=s&&void 0!==s.options&&(o.timeout=s.options.timeout),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),o.send(d(e)),o}function f(t,e,i,s){const o=m(i,s);return o.open("GET",`${t}?${d(e)}`,!0),null!=s&&void 0!==s.options&&(o.timeout=s.options.timeout,s.options.withCredentials&&(o.withCredentials=!0)),o.send(null),o}function g(t,e,i,s){const o=d(e),r=m(i,s),n=`${t}?${o}`.length;if(n<=2e3&&p.cors?r.open("GET",`${t}?${o}`):n>2e3&&p.cors&&(r.open("POST",t),r.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8")),null!=s&&void 0!==s.options&&(r.timeout=s.options.timeout,s.options.withCredentials&&(r.withCredentials=!0)),n<=2e3&&p.cors)r.send(null);else{if(!(n>2e3&&p.cors))return n<=2e3&&!p.cors?_(t,e,i,s):void v(`a request to ${t} was longer then 2000 characters and this browser cannot make a cross-domain post request. Please use a proxy https://developers.arcgis.com/esri-leaflet/api-reference/request/`);r.send(o)}return r}function _(t,i,s,o){window._EsriLeafletCallbacks=window._EsriLeafletCallbacks||{};const r=`c${c}`;i.callback=`window._EsriLeafletCallbacks.${r}`,window._EsriLeafletCallbacks[r]=function(t){if(!0!==window._EsriLeafletCallbacks[r]){let e;const i=Object.prototype.toString.call(t);"[object Object]"!==i&&"[object Array]"!==i&&(e={error:{code:500,message:"Expected array or object as JSONP response"}},t=null),!e&&t.error&&(e=t,t=null),s.call(o,e,t),window._EsriLeafletCallbacks[r]=!0}};const n=e.DomUtil.create("script",null,document.body);return n.type="text/javascript",n.src=`${t}?${d(i)}`,n.id=r,n.onerror=function(t){if(t&&!0!==window._EsriLeafletCallbacks[r]){const t={error:{code:500,message:"An unknown error occurred"}};s.call(o,t),window._EsriLeafletCallbacks[r]=!0}},e.DomUtil.addClass(n,"esri-leaflet-jsonp"),c++,{id:r,url:n.src,abort(){window._EsriLeafletCallbacks._callback[r]({code:0,message:"Request aborted."})}}}const b=p.cors?f:_;function v(...t){console&&console.warn&&console.warn.apply(console,t)}b.CORS=f,b.JSONP=_;const x={request:g,get:b,post:y};
/* @preserve
  * @terraformer/arcgis - v2.1.1 - MIT
  * Copyright (c) 2012-2022 Environmental Systems Research Institute, Inc.
  * Tue Aug 02 2022 14:23:48 GMT-0700 (Pacific Daylight Time)
  */var L=function(t,e,i,s){var o=(s[0]-i[0])*(t[1]-i[1])-(s[1]-i[1])*(t[0]-i[0]),r=(e[0]-t[0])*(t[1]-i[1])-(e[1]-t[1])*(t[0]-i[0]),n=(s[1]-i[1])*(e[0]-t[0])-(s[0]-i[0])*(e[1]-t[1]);if(0!==n){var a=o/n,l=r/n;if(a>=0&&a<=1&&l>=0&&l<=1)return!0}return!1},S=function(t,e){for(var i=0;i<t.length-1;i++)for(var s=0;s<e.length-1;s++)if(L(t[i],t[i+1],e[s],e[s+1]))return!0;return!1},A=function(t){return function(t,e){for(var i=0;i<t.length;i++)if(t[i]!==e[i])return!1;return!0}(t[0],t[t.length-1])||t.push(t[0]),t},T=function(t){for(var e,i=0,s=0,o=t.length,r=t[s];s<o-1;s++)i+=((e=t[s+1])[0]-r[0])*(e[1]+r[1]),r=e;return i>=0},w=function(t){var e={};for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e},I=function(t,e){var i=S(t,e),s=function(t,e){for(var i=!1,s=-1,o=t.length,r=o-1;++s<o;r=s)(t[s][1]<=e[1]&&e[1]<t[r][1]||t[r][1]<=e[1]&&e[1]<t[s][1])&&e[0]<(t[r][0]-t[s][0])*(e[1]-t[s][1])/(t[r][1]-t[s][1])+t[s][0]&&(i=!i);return i}(t,e[0]);return!(i||!s)},C=function t(e,i){var s={};if(e.features){s.type="FeatureCollection",s.features=[];for(var o=0;o<e.features.length;o++)s.features.push(t(e.features[o],i))}if("number"==typeof e.x&&"number"==typeof e.y&&(s.type="Point",s.coordinates=[e.x,e.y],"number"==typeof e.z&&s.coordinates.push(e.z)),e.points&&(s.type="MultiPoint",s.coordinates=e.points.slice(0)),e.paths&&(1===e.paths.length?(s.type="LineString",s.coordinates=e.paths[0].slice(0)):(s.type="MultiLineString",s.coordinates=e.paths.slice(0))),e.rings&&(s=function(t){for(var e,i,s,o=[],r=[],n=0;n<t.length;n++){var a=A(t[n].slice(0));if(!(a.length<4))if(T(a)){var l=[a.slice().reverse()];o.push(l)}else r.push(a.slice().reverse())}for(var h=[];r.length;){s=r.pop();var p=!1;for(e=o.length-1;e>=0;e--)if(i=o[e][0],I(i,s)){o[e].push(s),p=!0;break}p||h.push(s)}for(;h.length;){s=h.pop();var u=!1;for(e=o.length-1;e>=0;e--)if(i=o[e][0],S(i,s)){o[e].push(s),u=!0;break}u||o.push([s.reverse()])}return 1===o.length?{type:"Polygon",coordinates:o[0]}:{type:"MultiPolygon",coordinates:o}}(e.rings.slice(0))),"number"==typeof e.xmin&&"number"==typeof e.ymin&&"number"==typeof e.xmax&&"number"==typeof e.ymax&&(s.type="Polygon",s.coordinates=[[[e.xmax,e.ymax],[e.xmin,e.ymax],[e.xmin,e.ymin],[e.xmax,e.ymin],[e.xmax,e.ymax]]]),(e.geometry||e.attributes)&&(s.type="Feature",s.geometry=e.geometry?t(e.geometry):null,s.properties=e.attributes?w(e.attributes):null,e.attributes))try{s.id=function(t,e){for(var i=e?[e,"OBJECTID","FID"]:["OBJECTID","FID"],s=0;s<i.length;s++){var o=i[s];if(o in t&&("string"==typeof t[o]||"number"==typeof t[o]))return t[o]}throw Error("No valid id attribute found")}(e.attributes,i)}catch(t){}return JSON.stringify(s.geometry)===JSON.stringify({})&&(s.geometry=null),e.spatialReference&&e.spatialReference.wkid&&4326!==e.spatialReference.wkid&&console.warn("Object converted in non-standard crs - "+JSON.stringify(e.spatialReference)),s},O=function(t){var e=[],i=t.slice(0),s=A(i.shift().slice(0));if(s.length>=4){T(s)||s.reverse(),e.push(s);for(var o=0;o<i.length;o++){var r=A(i[o].slice(0));r.length>=4&&(T(r)&&r.reverse(),e.push(r))}}return e},P=function t(e,i){i=i||"OBJECTID";var s,o={wkid:4326},r={};switch(e.type){case"Point":r.x=e.coordinates[0],r.y=e.coordinates[1],null!=e.coordinates[2]&&(r.z=e.coordinates[2]),r.spatialReference=o;break;case"MultiPoint":r.points=e.coordinates.slice(0),null!=e.coordinates[0][2]&&(r.hasZ=!0),r.spatialReference=o;break;case"LineString":r.paths=[e.coordinates.slice(0)],null!=e.coordinates[0][2]&&(r.hasZ=!0),r.spatialReference=o;break;case"MultiLineString":r.paths=e.coordinates.slice(0),null!=e.coordinates[0][0][2]&&(r.hasZ=!0),r.spatialReference=o;break;case"Polygon":r.rings=O(e.coordinates.slice(0)),null!=e.coordinates[0][0][2]&&(r.hasZ=!0),r.spatialReference=o;break;case"MultiPolygon":r.rings=function(t){for(var e=[],i=0;i<t.length;i++)for(var s=O(t[i]),o=s.length-1;o>=0;o--){var r=s[o].slice(0);e.push(r)}return e}(e.coordinates.slice(0)),null!=e.coordinates[0][0][0][2]&&(r.hasZ=!0),r.spatialReference=o;break;case"Feature":e.geometry&&(r.geometry=t(e.geometry,i)),r.attributes=e.properties?w(e.properties):{},e.id&&(r.attributes[i]=e.id);break;case"FeatureCollection":for(r=[],s=0;s<e.features.length;s++)r.push(t(e.features[s],i));break;case"GeometryCollection":for(r=[],s=0;s<e.geometries.length;s++)r.push(t(e.geometries[s],i))}return r};function F(t,e){return P(t,e)}function R(t,e){return C(t,e)}function U(t){if("NaN"!==t.xmin&&"NaN"!==t.ymin&&"NaN"!==t.xmax&&"NaN"!==t.ymax){const i=e.latLng(t.ymin,t.xmin),s=e.latLng(t.ymax,t.xmax);return e.latLngBounds(i,s)}return null}function k(t){return{xmin:(t=e.latLngBounds(t)).getSouthWest().lng,ymin:t.getSouthWest().lat,xmax:t.getNorthEast().lng,ymax:t.getNorthEast().lat,spatialReference:{wkid:4326}}}const G=/^(OBJECTID|FID|OID|ID)$/i;function M(t){let e;if(t.objectIdFieldName)e=t.objectIdFieldName;else if(t.fields){for(let i=0;i<=t.fields.length-1;i++)if("esriFieldTypeOID"===t.fields[i].type){e=t.fields[i].name;break}if(!e)for(let i=0;i<=t.fields.length-1;i++)if(t.fields[i].name.match(G)){e=t.fields[i].name;break}}return e}function B(t){for(const e in t.attributes)if(e.match(G))return e}function E(t,e){let i;const s=t.features||t.results,o=s&&s.length;i=e||M(t);const r={type:"FeatureCollection",features:[]};if(o)for(let t=s.length-1;t>=0;t--){const e=R(s[t],i||B(s[t]));r.features.push(e)}return r}function D(t){return"/"!==(t=e.Util.trim(t))[t.length-1]&&(t+="/"),t}function z(t){if(-1!==t.url.indexOf("?")){t.requestParams=t.requestParams||{};const e=t.url.substring(t.url.indexOf("?")+1);t.url=t.url.split("?")[0],t.requestParams=JSON.parse(`{"${decodeURI(e).replace(/"/g,'\\"').replace(/&/g,'","').replace(/=/g,'":"')}"}`)}return t.url=D(t.url.split("?")[0]),t}function q(t){return/^(?!.*utility\.arcgis\.com).*\.arcgis\.com.*FeatureServer/i.test(t)}function Z(t){let e;switch(t){case"Point":e="esriGeometryPoint";break;case"MultiPoint":e="esriGeometryMultipoint";break;case"LineString":case"MultiLineString":e="esriGeometryPolyline";break;case"Polygon":case"MultiPolygon":e="esriGeometryPolygon"}return e}function $(t){return t.getSize().x-u.attributionWidthOffset+"px"}function N(t){if(t.attributionControl){if(t.attributionControl._esriAttributionLayerCount||(t.attributionControl._esriAttributionLayerCount=0),0===t.attributionControl._esriAttributionLayerCount){if(!t.attributionControl._esriAttributionAddedOnce){const e=document.createElement("style");e.type="text/css",e.innerHTML=".esri-truncated-attribution:hover {white-space: normal;}",document.getElementsByTagName("head")[0].appendChild(e);const i=document.createElement("style");i.type="text/css",i.innerHTML=`.esri-truncated-attribution {vertical-align: -3px;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;display: inline-block;transition: 0s white-space;transition-delay: 1s;max-width: ${$(t)};}`,document.getElementsByTagName("head")[0].appendChild(i),t.on("resize",e=>{t.attributionControl&&(t.attributionControl._container.style.maxWidth=$(e.target))}),t.attributionControl._esriAttributionAddedOnce=!0}e.DomUtil.addClass(t.attributionControl._container,"esri-truncated-attribution:hover"),e.DomUtil.addClass(t.attributionControl._container,"esri-truncated-attribution")}t.attributionControl._esriAttributionLayerCount=t.attributionControl._esriAttributionLayerCount+1}}function j(){return'Powered by <a href="https://www.esri.com">Esri</a>'}function W(t){t.attributionControl&&(t.attributionControl._esriAttributionLayerCount&&1===t.attributionControl._esriAttributionLayerCount&&(e.DomUtil.removeClass(t.attributionControl._container,"esri-truncated-attribution:hover"),e.DomUtil.removeClass(t.attributionControl._container,"esri-truncated-attribution")),t.attributionControl._esriAttributionLayerCount=t.attributionControl._esriAttributionLayerCount-1)}function J(t){const i={geometry:null,geometryType:null};return t instanceof e.LatLngBounds?(i.geometry=k(t),i.geometryType="esriGeometryEnvelope",i):(t.getLatLng&&(t=t.getLatLng()),t instanceof e.LatLng&&(t={type:"Point",coordinates:[t.lng,t.lat]}),t instanceof e.GeoJSON&&(t=t.getLayers()[0].feature.geometry,i.geometry=F(t),i.geometryType=Z(t.type)),t.toGeoJSON&&(t=t.toGeoJSON()),"Feature"===t.type&&(t=t.geometry),"Point"===t.type||"LineString"===t.type||"Polygon"===t.type||"MultiPolygon"===t.type?(i.geometry=F(t),i.geometryType=Z(t.type),i):void v("invalid geometry passed to spatial query. Should be L.LatLng, L.LatLngBounds, L.Marker or a GeoJSON Point, Line, Polygon or MultiPolygon object"))}function V(t,i){p.cors&&g(t,{},e.Util.bind((t,s)=>{if(t)return;i._esriAttributions=[];for(let t=0;t<s.contributors.length;t++){const o=s.contributors[t];for(let t=0;t<o.coverageAreas.length;t++){const s=o.coverageAreas[t],r=e.latLng(s.bbox[0],s.bbox[1]),n=e.latLng(s.bbox[2],s.bbox[3]);i._esriAttributions.push({attribution:o.attribution,score:s.score,bounds:e.latLngBounds(r,n),minZoom:s.zoomMin,maxZoom:s.zoomMax})}}i._esriAttributions.sort((t,e)=>e.score-t.score);Q({target:i})},this))}function Q(t){const i=t.target,s=i._esriAttributions;if(!i||!i.attributionControl)return;const o=i.attributionControl._container.querySelector(".esri-dynamic-attribution");if(o&&s){let t="";const r=i.getBounds(),n=e.latLngBounds(r.getSouthWest().wrap(),r.getNorthEast().wrap()),a=i.getZoom();for(let e=0;e<s.length;e++){const i=s[e],o=i.attribution;!t.match(o)&&i.bounds.intersects(n)&&a>=i.minZoom&&a<=i.maxZoom&&(t+=`, ${o}`)}t=`Powered by <a href="https://www.esri.com">Esri</a> | ${t.substr(2)}`,o.innerHTML=t,o.style.maxWidth=$(i),i.fire("attributionupdated",{attribution:t})}}const H={warn:v,cleanUrl:D,getUrlParams:z,isArcgisOnline:q,geojsonTypeToArcGIS:Z,responseToFeatureCollection:E,geojsonToArcGIS:F,arcgisToGeoJSON:R,boundsToExtent:k,extentToBounds:U,calcAttributionWidth:$,setEsriAttribution:N,getEsriAttributionHtmlString:j,removeEsriAttribution:W,_setGeometry:J,_getAttributionData:V,_updateMapAttribution:Q,_findIdAttributeFromFeature:B,_findIdAttributeFromResponse:M},K=e.Class.extend({options:{proxy:!1,useCors:l},generateSetter:(t,i)=>e.Util.bind(function(e){return this.params[t]=e,this},i),initialize(t){if(t.request&&t.options?(this._service=t,e.Util.setOptions(this,t.options)):(e.Util.setOptions(this,t),this.options.url=D(t.url)),this.params=e.Util.extend({},this.params||{}),this.setters)for(const t in this.setters){const e=this.setters[t];this[t]=this.generateSetter(e,this)}},token(t){return this._service?this._service.authenticate(t):this.params.token=t,this},apikey(t){return this.token(t)},format(t){return this.params.returnUnformattedValues=!t,this},request(t,i){return this.options.requestParams&&e.Util.extend(this.params,this.options.requestParams),this._service?this._service.request(this.path,this.params,t,i):this._request("request",this.path,this.params,t,i)},_request(t,e,i,s,o){const r=this.options.proxy?`${this.options.proxy}?${this.options.url}${e}`:this.options.url+e;return"get"!==t&&"request"!==t||this.options.useCors?x[t](r,i,s,o):x.get.JSONP(r,i,s,o)}});const X=K.extend({setters:{offset:"resultOffset",limit:"resultRecordCount",fields:"outFields",precision:"geometryPrecision",featureIds:"objectIds",returnGeometry:"returnGeometry",returnM:"returnM",transform:"datumTransformation",token:"token"},path:"query",params:{returnGeometry:!0,where:"1=1",outSR:4326,outFields:"*"},within(t){return this._setGeometryParams(t),this.params.spatialRel="esriSpatialRelContains",this},intersects(t){return this._setGeometryParams(t),this.params.spatialRel="esriSpatialRelIntersects",this},contains(t){return this._setGeometryParams(t),this.params.spatialRel="esriSpatialRelWithin",this},crosses(t){return this._setGeometryParams(t),this.params.spatialRel="esriSpatialRelCrosses",this},touches(t){return this._setGeometryParams(t),this.params.spatialRel="esriSpatialRelTouches",this},overlaps(t){return this._setGeometryParams(t),this.params.spatialRel="esriSpatialRelOverlaps",this},bboxIntersects(t){return this._setGeometryParams(t),this.params.spatialRel="esriSpatialRelEnvelopeIntersects",this},indexIntersects(t){return this._setGeometryParams(t),this.params.spatialRel="esriSpatialRelIndexIntersects",this},nearby(t,i){return t=e.latLng(t),this.params.geometry=[t.lng,t.lat],this.params.geometryType="esriGeometryPoint",this.params.spatialRel="esriSpatialRelIntersects",this.params.units="esriSRUnit_Meter",this.params.distance=i,this.params.inSR=4326,this},where(t){return this.params.where=t,this},between(t,e){return this.params.time=[t.valueOf(),e.valueOf()],this},simplify(t,e){const i=Math.abs(t.getBounds().getWest()-t.getBounds().getEast());return this.params.maxAllowableOffset=i/t.getSize().y*e,this},orderBy(t,e){return e=e||"ASC",this.params.orderByFields=this.params.orderByFields?`${this.params.orderByFields},`:"",this.params.orderByFields+=[t,e].join(" "),this},run(t,e){return this._cleanParams(),this.options.isModern||q(this.options.url)&&void 0===this.options.isModern?(this.params.f="geojson",this.request(function(i,s){this._trapSQLerrors(i),t.call(e,i,s,s)},this)):this.request(function(i,s){this._trapSQLerrors(i),t.call(e,i,s&&E(s),s)},this)},count(t,e){return this._cleanParams(),this.params.returnCountOnly=!0,this.request(function(e,i){t.call(this,e,i&&i.count,i)},e)},ids(t,e){return this._cleanParams(),this.params.returnIdsOnly=!0,this.request(function(e,i){t.call(this,e,i&&i.objectIds,i)},e)},bounds(t,e){return this._cleanParams(),this.params.returnExtentOnly=!0,this.request((i,s)=>{s&&s.extent&&U(s.extent)?t.call(e,i,U(s.extent),s):(i={message:"Invalid Bounds"},t.call(e,i,null,s))},e)},distinct(){return this.params.returnGeometry=!1,this.params.returnDistinctValues=!0,this},pixelSize(t){const i=e.point(t);return this.params.pixelSize=[i.x,i.y],this},layer(t){return this.path=`${t}/query`,this},_trapSQLerrors(t){t&&"400"===t.code&&v("one common syntax error in query requests is encasing string values in double quotes instead of single quotes")},_cleanParams(){delete this.params.returnIdsOnly,delete this.params.returnExtentOnly,delete this.params.returnCountOnly},_setGeometryParams(t){this.params.inSR=4326;const e=J(t);this.params.geometry=e.geometry,this.params.geometryType=e.geometryType}});function Y(t){return new X(t)}const tt=K.extend({setters:{contains:"contains",text:"searchText",fields:"searchFields",spatialReference:"sr",sr:"sr",layers:"layers",returnGeometry:"returnGeometry",maxAllowableOffset:"maxAllowableOffset",precision:"geometryPrecision",dynamicLayers:"dynamicLayers",returnZ:"returnZ",returnM:"returnM",gdbVersion:"gdbVersion",token:"token"},path:"find",params:{sr:4326,contains:!0,returnGeometry:!0,returnZ:!0,returnM:!1},layerDefs(t,e){return this.params.layerDefs=this.params.layerDefs?`${this.params.layerDefs};`:"",this.params.layerDefs+=[t,e].join(":"),this},simplify(t,e){const i=Math.abs(t.getBounds().getWest()-t.getBounds().getEast());return this.params.maxAllowableOffset=i/t.getSize().y*e,this},run(t,e){return this.request((i,s)=>{t.call(e,i,s&&E(s),s)},e)}});function et(t){return new tt(t)}const it=K.extend({path:"identify",between(t,e){return this.params.time=[t.valueOf(),e.valueOf()],this}});const st=it.extend({setters:{layers:"layers",precision:"geometryPrecision",tolerance:"tolerance",returnGeometry:"returnGeometry"},params:{sr:4326,layers:"all",tolerance:3,returnGeometry:!0},on(t){const e=k(t.getBounds()),i=t.getSize();return this.params.imageDisplay=[i.x,i.y,96],this.params.mapExtent=[e.xmin,e.ymin,e.xmax,e.ymax],this},at(t){return 2===t.length&&(t=e.latLng(t)),this._setGeometryParams(t),this},layerDef(t,e){return this.params.layerDefs=this.params.layerDefs?`${this.params.layerDefs};`:"",this.params.layerDefs+=[t,e].join(":"),this},simplify(t,e){const i=Math.abs(t.getBounds().getWest()-t.getBounds().getEast());return this.params.maxAllowableOffset=i/t.getSize().y*e,this},run(t,e){return this.request((i,s)=>{if(i)t.call(e,i,void 0,s);else{const i=E(s);s.results=s.results.reverse();for(let t=0;t<i.features.length;t++){i.features[t].layerId=s.results[t].layerId}t.call(e,void 0,i,s)}})},_setGeometryParams(t){const e=J(t);this.params.geometry=e.geometry,this.params.geometryType=e.geometryType}});function ot(t){return new st(t)}const rt=it.extend({setters:{setMosaicRule:"mosaicRule",setRenderingRule:"renderingRule",setPixelSize:"pixelSize",returnCatalogItems:"returnCatalogItems",returnGeometry:"returnGeometry"},params:{returnGeometry:!1},at(t){return t=e.latLng(t),this.params.geometry=JSON.stringify({x:t.lng,y:t.lat,spatialReference:{wkid:4326}}),this.params.geometryType="esriGeometryPoint",this},getMosaicRule(){return this.params.mosaicRule},getRenderingRule(){return this.params.renderingRule},getPixelSize(){return this.params.pixelSize},run(t,e){return this.request(function(i,s){t.call(e,i,s&&this._responseToGeoJSON(s),s)},this)},_responseToGeoJSON(t){const e=t.location,i=t.catalogItems,s=t.catalogItemVisibilities,o={pixel:{type:"Feature",geometry:{type:"Point",coordinates:[e.x,e.y]},crs:{type:"EPSG",properties:{code:e.spatialReference.wkid}},properties:{OBJECTID:t.objectId,name:t.name,value:t.value},id:t.objectId}};if(t.properties&&t.properties.Values&&(o.pixel.properties.values=t.properties.Values),i&&i.features&&(o.catalogItems=E(i),s&&s.length===o.catalogItems.features.length))for(let t=s.length-1;t>=0;t--)o.catalogItems.features[t].properties.catalogItemVisibility=s[t];return o}});function nt(t){return new rt(t)}const at=e.Evented.extend({options:{proxy:!1,useCors:l,timeout:0},initialize(t){t=t||{},this._requestQueue=[],this._authenticating=!1,e.Util.setOptions(this,t),this.options.url=D(this.options.url)},get(t,e,i,s){return this._request("get",t,e,i,s)},post(t,e,i,s){return this._request("post",t,e,i,s)},request(t,e,i,s){return this._request("request",t,e,i,s)},metadata(t,e){return this._request("get","",{},t,e)},authenticate(t){return this._authenticating=!1,this.options.token=t,this._runQueue(),this},getTimeout(){return this.options.timeout},setTimeout(t){this.options.timeout=t},_request(t,i,s,o,r){this.fire("requeststart",{url:this.options.url+i,params:s,method:t},!0);const n=this._createServiceCallback(t,i,s,o,r);if(this.options.token&&(s.token=this.options.token),this.options.requestParams&&e.Util.extend(s,this.options.requestParams),!this._authenticating){const e=this.options.proxy?`${this.options.proxy}?${this.options.url}${i}`:this.options.url+i;return"get"!==t&&"request"!==t||this.options.useCors?x[t](e,s,n,r):x.get.JSONP(e,s,n,r)}this._requestQueue.push([t,i,s,o,r])},_createServiceCallback(t,i,s,o,r){return e.Util.bind(function(n,a){!n||499!==n.code&&498!==n.code||(this._authenticating=!0,this._requestQueue.push([t,i,s,o,r]),this.fire("authenticationrequired",{authenticate:e.Util.bind(this.authenticate,this)},!0),n.authenticate=e.Util.bind(this.authenticate,this)),o.call(r,n,a),n?this.fire("requesterror",{url:this.options.url+i,params:s,message:n.message,code:n.code,method:t},!0):this.fire("requestsuccess",{url:this.options.url+i,params:s,response:a,method:t},!0),this.fire("requestend",{url:this.options.url+i,params:s,method:t},!0)},this)},_runQueue(){for(let t=this._requestQueue.length-1;t>=0;t--){const e=this._requestQueue[t];this[e.shift()].apply(this,e)}this._requestQueue=[]}});const lt=at.extend({identify(){return ot(this)},find(){return et(this)},query(){return Y(this)}});function ht(t){return new lt(t)}const pt=at.extend({query(){return Y(this)},identify(){return nt(this)}});function ut(t){return new pt(t)}const ct=at.extend({options:{idAttribute:"OBJECTID"},query(){return Y(this)},addFeature(t,e,i){this.addFeatures(t,e,i)},addFeatures(t,e,i){const s=t.features?t.features:[t];for(let t=s.length-1;t>=0;t--)delete s[t].id;return t=F(t),t=s.length>1?t:[t],this.post("addFeatures",{features:t},(t,s)=>{const o=s&&s.addResults?s.addResults.length>1?s.addResults:s.addResults[0]:void 0;e&&e.call(i,t||s.addResults[0].error,o)},i)},updateFeature(t,e,i){this.updateFeatures(t,e,i)},updateFeatures(t,e,i){const s=t.features?t.features:[t];return t=F(t,this.options.idAttribute),t=s.length>1?t:[t],this.post("updateFeatures",{features:t},(t,s)=>{const o=s&&s.updateResults?s.updateResults.length>1?s.updateResults:s.updateResults[0]:void 0;e&&e.call(i,t||s.updateResults[0].error,o)},i)},deleteFeature(t,e,i){this.deleteFeatures(t,e,i)},deleteFeatures(t,e,i){return this.post("deleteFeatures",{objectIds:t},(t,s)=>{const o=s&&s.deleteResults?s.deleteResults.length>1?s.deleteResults:s.deleteResults[0]:void 0;e&&e.call(i,t||s.deleteResults[0].error,o)},i)}});function dt(t){return new ct(t)}const mt="https:"!==window.location.protocol?"http:":"https:",yt=e.TileLayer.extend({statics:{TILES:{Streets:{urlTemplate:`${mt}//{s}.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}`,options:{minZoom:1,maxZoom:19,subdomains:["server","services"],attribution:"USGS, NOAA",attributionUrl:"https://static.arcgis.com/attribution/World_Street_Map"}},Topographic:{urlTemplate:`${mt}//{s}.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}`,options:{minZoom:1,maxZoom:19,subdomains:["server","services"],attribution:"USGS, NOAA",attributionUrl:"https://static.arcgis.com/attribution/World_Topo_Map"}},Oceans:{urlTemplate:`${mt}//{s}.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}`,options:{minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:"USGS, NOAA",attributionUrl:"https://static.arcgis.com/attribution/Ocean_Basemap"}},OceansLabels:{urlTemplate:`${mt}//{s}.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Reference/MapServer/tile/{z}/{y}/{x}`,options:{minZoom:1,maxZoom:16,subdomains:["server","services"],pane:h?"esri-labels":"tilePane",attribution:""}},NationalGeographic:{urlTemplate:`${mt}//{s}.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}`,options:{minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:"National Geographic, DeLorme, HERE, UNEP-WCMC, USGS, NASA, ESA, METI, NRCAN, GEBCO, NOAA, increment P Corp."}},DarkGray:{urlTemplate:`${mt}//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer/tile/{z}/{y}/{x}`,options:{minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:"HERE, DeLorme, MapmyIndia, &copy; OpenStreetMap contributors"}},DarkGrayLabels:{urlTemplate:`${mt}//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Reference/MapServer/tile/{z}/{y}/{x}`,options:{minZoom:1,maxZoom:16,subdomains:["server","services"],pane:h?"esri-labels":"tilePane",attribution:""}},Gray:{urlTemplate:`${mt}//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}`,options:{minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:"HERE, DeLorme, MapmyIndia, &copy; OpenStreetMap contributors"}},GrayLabels:{urlTemplate:`${mt}//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer/tile/{z}/{y}/{x}`,options:{minZoom:1,maxZoom:16,subdomains:["server","services"],pane:h?"esri-labels":"tilePane",attribution:""}},Imagery:{urlTemplate:`${mt}//{s}.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}`,options:{minZoom:1,maxZoom:19,subdomains:["server","services"],attribution:"DigitalGlobe, GeoEye, i-cubed, USDA, USGS, AEX, Getmapping, Aerogrid, IGN, IGP, swisstopo, and the GIS User Community",attributionUrl:"https://static.arcgis.com/attribution/World_Imagery"}},ImageryLabels:{urlTemplate:`${mt}//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}`,options:{minZoom:1,maxZoom:19,subdomains:["server","services"],pane:h?"esri-labels":"tilePane",attribution:""}},ImageryTransportation:{urlTemplate:`${mt}//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}`,options:{minZoom:1,maxZoom:19,subdomains:["server","services"],pane:h?"esri-labels":"tilePane",attribution:""}},ShadedRelief:{urlTemplate:`${mt}//{s}.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}`,options:{minZoom:1,maxZoom:13,subdomains:["server","services"],attribution:"USGS"}},ShadedReliefLabels:{urlTemplate:`${mt}//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places_Alternate/MapServer/tile/{z}/{y}/{x}`,options:{minZoom:1,maxZoom:12,subdomains:["server","services"],pane:h?"esri-labels":"tilePane",attribution:""}},Terrain:{urlTemplate:`${mt}//{s}.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}`,options:{minZoom:1,maxZoom:13,subdomains:["server","services"],attribution:"USGS, NOAA"}},TerrainLabels:{urlTemplate:`${mt}//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Reference_Overlay/MapServer/tile/{z}/{y}/{x}`,options:{minZoom:1,maxZoom:13,subdomains:["server","services"],pane:h?"esri-labels":"tilePane",attribution:""}},USATopo:{urlTemplate:`${mt}//{s}.arcgisonline.com/ArcGIS/rest/services/USA_Topo_Maps/MapServer/tile/{z}/{y}/{x}`,options:{minZoom:1,maxZoom:15,subdomains:["server","services"],attribution:"USGS, National Geographic Society, i-cubed"}},ImageryClarity:{urlTemplate:`${mt}//clarity.maptiles.arcgis.com/arcgis/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}`,options:{minZoom:1,maxZoom:19,attribution:"Esri, DigitalGlobe, GeoEye, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, and the GIS User Community"}},Physical:{urlTemplate:`${mt}//{s}.arcgisonline.com/arcgis/rest/services/World_Physical_Map/MapServer/tile/{z}/{y}/{x}`,options:{minZoom:1,maxZoom:8,subdomains:["server","services"],attribution:"U.S. National Park Service"}},ImageryFirefly:{urlTemplate:`${mt}//fly.maptiles.arcgis.com/arcgis/rest/services/World_Imagery_Firefly/MapServer/tile/{z}/{y}/{x}`,options:{minZoom:1,maxZoom:19,attribution:"Esri, DigitalGlobe, GeoEye, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, and the GIS User Community",attributionUrl:"https://static.arcgis.com/attribution/World_Imagery"}}}},initialize(t,i){let s;if("object"==typeof t&&t.urlTemplate&&t.options)s=t;else{if("string"!=typeof t||!yt.TILES[t])throw new Error('L.esri.BasemapLayer: Invalid parameter. Use one of "Streets", "Topographic", "Oceans", "OceansLabels", "NationalGeographic", "Physical", "Gray", "GrayLabels", "DarkGray", "DarkGrayLabels", "Imagery", "ImageryLabels", "ImageryTransportation", "ImageryClarity", "ImageryFirefly", ShadedRelief", "ShadedReliefLabels", "Terrain", "TerrainLabels" or "USATopo"');s=yt.TILES[t]}const o=e.Util.extend(s.options,i);e.Util.setOptions(this,o),this.options.ignoreDeprecationWarning||console.warn("WARNING: L.esri.BasemapLayer uses data services that are in mature support and are not being updated. Please use L.esri.Vector.vectorBasemapLayer instead. More info: https://esriurl.com/esri-leaflet-basemap"),this.options.token&&-1===s.urlTemplate.indexOf("token=")&&(s.urlTemplate+=`?token=${this.options.token}`),this.options.proxy&&(s.urlTemplate=`${this.options.proxy}?${s.urlTemplate}`),e.TileLayer.prototype.initialize.call(this,s.urlTemplate,o)},onAdd(t){N(t),"esri-labels"===this.options.pane&&this._initPane(),this.options.attributionUrl&&V((this.options.proxy?`${this.options.proxy}?`:"")+this.options.attributionUrl,t),t.on("moveend",Q),e.TileLayer.prototype.onAdd.call(this,t)},onRemove(t){W(t),t.off("moveend",Q),e.TileLayer.prototype.onRemove.call(this,t)},_initPane(){if(!this._map.getPane(this.options.pane)){const t=this._map.createPane(this.options.pane);t.style.pointerEvents="none",t.style.zIndex=500}},getAttribution(){let t;return this.options.attribution&&(t=`<span class="esri-dynamic-attribution">${this.options.attribution}</span>`),t}});const ft=e.TileLayer.extend({options:{zoomOffsetAllowance:.1,errorTileUrl:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEABAMAAACuXLVVAAAAA1BMVEUzNDVszlHHAAAAAXRSTlMAQObYZgAAAAlwSFlzAAAAAAAAAAAB6mUWpAAAADZJREFUeJztwQEBAAAAgiD/r25IQAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA7waBAAABw08RwAAAAABJRU5ErkJggg=="},statics:{MercatorZoomLevels:{0:156543.033928,1:78271.5169639999,2:39135.7584820001,3:19567.8792409999,4:9783.93962049996,5:4891.96981024998,6:2445.98490512499,7:1222.99245256249,8:611.49622628138,9:305.748113140558,10:152.874056570411,11:76.4370282850732,12:38.2185141425366,13:19.1092570712683,14:9.55462853563415,15:4.77731426794937,16:2.38865713397468,17:1.19432856685505,18:.597164283559817,19:.298582141647617,20:.14929107082381,21:.07464553541191,22:.0373227677059525,23:.0186613838529763}},initialize(t){(t=e.Util.setOptions(this,t)).apikey&&(t.token=t.apikey),t=z(t),this.tileUrl=`${(t.proxy?`${t.proxy}?`:"")+t.url}tile/{z}/{y}/{x}${t.requestParams&&Object.keys(t.requestParams).length>0?e.Util.getParamString(t.requestParams):""}`,-1!==t.url.indexOf("{s}")&&t.subdomains&&(t.url=t.url.replace("{s}",t.subdomains[0])),this.service=ht(t),this.service.addEventParent(this);new RegExp(/tiles.arcgis(online)?\.com/g).test(t.url)&&(this.tileUrl=this.tileUrl.replace("://tiles","://tiles{s}"),t.subdomains=["1","2","3","4"]),this.options.token&&(this.tileUrl+=`?token=${this.options.token}`),e.TileLayer.prototype.initialize.call(this,this.tileUrl,t)},getTileUrl(t){const i=this._getZoomForUrl();return e.Util.template(this.tileUrl,e.Util.extend({s:this._getSubdomain(t),x:t.x,y:t.y,z:this._lodMap&&void 0!==this._lodMap[i]?this._lodMap[i]:i},this.options))},createTile(t,i){const s=document.createElement("img");return e.DomEvent.on(s,"load",e.Util.bind(this._tileOnLoad,this,i,s)),e.DomEvent.on(s,"error",e.Util.bind(this._tileOnError,this,i,s)),this.options.crossOrigin&&(s.crossOrigin=""),s.alt="",!this._lodMap||this._lodMap&&void 0!==this._lodMap[this._getZoomForUrl()]?s.src=this.getTileUrl(t):this.once("lodmap",function(){s.src=this.getTileUrl(t)},this),s},onAdd(t){N(t),this._lodMap||this.metadata(function(i,s){if(!i&&s.spatialReference){const i=s.spatialReference.latestWkid||s.spatialReference.wkid;if(!this.options.attribution&&t.attributionControl&&s.copyrightText&&(this.options.attribution=s.copyrightText,t.attributionControl.addAttribution(this.getAttribution())),t.options.crs!==e.CRS.EPSG3857||102100!==i&&3857!==i)t.options.crs&&t.options.crs.code&&t.options.crs.code.indexOf(i)>-1||v("L.esri.TiledMapLayer is using a non-mercator spatial reference. Support may be available through Proj4Leaflet https://developers.arcgis.com/esri-leaflet/samples/non-mercator-projection/");else{this._lodMap={};const t=s.tileInfo.lods,e=ft.MercatorZoomLevels;for(let i=0;i<t.length;i++){const s=t[i];for(const t in e){const i=e[t];if(this._withinPercentage(s.resolution,i,this.options.zoomOffsetAllowance)){this._lodMap[t]=s.level;break}}}this.fire("lodmap")}}},this),e.TileLayer.prototype.onAdd.call(this,t)},onRemove(t){W(t),e.TileLayer.prototype.onRemove.call(this,t)},metadata(t,e){return this.service.metadata(t,e),this},identify(){return this.service.identify()},find(){return this.service.find()},query(){return this.service.query()},authenticate(t){const e=`?token=${t}`;return this.tileUrl=this.options.token?this.tileUrl.replace(/\?token=(.+)/g,e):this.tileUrl+e,this.options.token=t,this.service.authenticate(t),this},_withinPercentage:(t,e,i)=>Math.abs(t/e-1)<i});const gt=e.ImageOverlay.extend({onAdd(t){this._topLeft=t.getPixelBounds().min,e.ImageOverlay.prototype.onAdd.call(this,t)},_reset(){this._map.options.crs===e.CRS.EPSG3857?e.ImageOverlay.prototype._reset.call(this):e.DomUtil.setPosition(this._image,this._topLeft.subtract(this._map.getPixelOrigin()))}}),_t=e.Layer.extend({options:{opacity:1,position:"front",f:"image",useCors:l,attribution:null,interactive:!1,alt:""},onAdd(t){N(t),this.options.zIndex&&(this.options.position=null),this._update=e.Util.throttle(this._update,this.options.updateInterval,this),t.on("moveend",this._update,this),this._currentImage&&this._currentImage._bounds.equals(this._map.getBounds())?t.addLayer(this._currentImage):this._currentImage&&(this._map.removeLayer(this._currentImage),this._currentImage=null),this._update(),this._popup&&(this._map.on("click",this._getPopupData,this),this._map.on("dblclick",this._resetPopupState,this)),this.metadata(function(e,i){!e&&!this.options.attribution&&t.attributionControl&&i.copyrightText&&(this.options.attribution=i.copyrightText,t.attributionControl.addAttribution(this.getAttribution()))},this)},onRemove(t){W(t),this._currentImage&&this._map.removeLayer(this._currentImage),this._popup&&(this._map.off("click",this._getPopupData,this),this._map.off("dblclick",this._resetPopupState,this)),this._map.off("moveend",this._update,this)},bindPopup(t,i){return this._shouldRenderPopup=!1,this._lastClick=!1,this._popup=e.popup(i),this._popupFunction=t,this._map&&(this._map.on("click",this._getPopupData,this),this._map.on("dblclick",this._resetPopupState,this)),this},unbindPopup(){return this._map&&(this._map.closePopup(this._popup),this._map.off("click",this._getPopupData,this),this._map.off("dblclick",this._resetPopupState,this)),this._popup=!1,this},bringToFront(){return this.options.position="front",this._currentImage&&(this._currentImage.bringToFront(),this._setAutoZIndex(Math.max)),this},bringToBack(){return this.options.position="back",this._currentImage&&(this._currentImage.bringToBack(),this._setAutoZIndex(Math.min)),this},setZIndex(t){return this.options.zIndex=t,this._currentImage&&this._currentImage.setZIndex(t),this},_setAutoZIndex(t){if(!this._currentImage)return;const e=this._currentImage.getPane().children;let i=-t(-1/0,1/0);for(let s,o=0,r=e.length;o<r;o++)s=e[o].style.zIndex,e[o]!==this._currentImage._image&&s&&(i=t(i,+s));isFinite(i)&&(this.options.zIndex=i+t(-1,1),this.setZIndex(this.options.zIndex))},getAttribution(){return this.options.attribution},getOpacity(){return this.options.opacity},setOpacity(t){return this.options.opacity=t,this._currentImage&&this._currentImage.setOpacity(t),this},getTimeRange(){return[this.options.from,this.options.to]},setTimeRange(t,e){return this.options.from=t,this.options.to=e,this._update(),this},metadata(t,e){return this.service.metadata(t,e),this},authenticate(t){return this.service.authenticate(t),this},redraw(){this._update()},_renderImage(t,e,i){if(this._map){if(i&&(t=`data:${i};base64,${t}`),!t)return;const s=new gt(t,e,{opacity:0,crossOrigin:this.options.withCredentials?"use-credentials":this.options.useCors,alt:this.options.alt,pane:this.options.pane||this.getPane(),interactive:this.options.interactive}).addTo(this._map);let o;const r=function(){this._map.removeLayer(s),this.fire("error"),s.off("load",o,this)};o=function(t){if(s.off("error",r,this),this._map){const i=t.target,s=this._currentImage;i._bounds.equals(e)&&i._bounds.equals(this._map.getBounds())?(this._currentImage=i,"front"===this.options.position?this.bringToFront():"back"===this.options.position&&this.bringToBack(),this.options.zIndex&&this.setZIndex(this.options.zIndex),this._map&&this._currentImage._map?this._currentImage.setOpacity(this.options.opacity):this._currentImage._map.removeLayer(this._currentImage),s&&this._map&&this._map.removeLayer(s),s&&s._map&&s._map.removeLayer(s)):this._map.removeLayer(i)}this.fire("load",{bounds:e})},s.once("error",r,this),s.once("load",o,this)}},_update(){if(!this._map)return;const t=this._map.getZoom(),i=this._map.getBounds();if(this._animatingZoom)return;if(this._map._panTransition&&this._map._panTransition._inProgress)return;if(t>this.options.maxZoom||t<this.options.minZoom)return void(this._currentImage&&(this._currentImage._map.removeLayer(this._currentImage),this._currentImage=null));const s=this._buildExportParams();e.Util.extend(s,this.options.requestParams),s?(this._requestExport(s,i),this.fire("loading",{bounds:i})):this._currentImage&&(this._currentImage._map.removeLayer(this._currentImage),this._currentImage=null)},_renderPopup(t,i,s,o){if(t=e.latLng(t),this._shouldRenderPopup&&this._lastClick.equals(t)){const e=this._popupFunction(i,s,o);e&&this._popup.setLatLng(t).setContent(e).openOn(this._map)}},_resetPopupState(t){this._shouldRenderPopup=!1,this._lastClick=t.latlng},_calculateBbox(){const t=this._map.getPixelBounds(),i=this._map.unproject(t.getBottomLeft()),s=this._map.unproject(t.getTopRight()),o=this._map.options.crs.project(s),r=this._map.options.crs.project(i),n=e.bounds(o,r);return[n.getBottomLeft().x,n.getBottomLeft().y,n.getTopRight().x,n.getTopRight().y].join(",")},_calculateImageSize(){const t=this._map.getPixelBounds(),e=this._map.getSize(),i=this._map.unproject(t.getBottomLeft()),s=this._map.unproject(t.getTopRight()),o=this._map.latLngToLayerPoint(s).y,r=this._map.latLngToLayerPoint(i).y;return(o>0||r<e.y)&&(e.y=r-o),`${e.x},${e.y}`}}),bt=_t.extend({options:{updateInterval:150,format:"jpgpng",transparent:!0,f:"image"},query(){return this.service.query()},identify(){return this.service.identify()},initialize(t){t=z(t),this.service=ut(t),this.service.addEventParent(this),e.Util.setOptions(this,t)},setPixelType(t){return this.options.pixelType=t,this._update(),this},getPixelType(){return this.options.pixelType},setBandIds(t){return e.Util.isArray(t)?this.options.bandIds=t.join(","):this.options.bandIds=t.toString(),this._update(),this},getBandIds(){return this.options.bandIds},setNoData(t,i){return e.Util.isArray(t)?this.options.noData=t.join(","):this.options.noData=t.toString(),i&&(this.options.noDataInterpretation=i),this._update(),this},getNoData(){return this.options.noData},getNoDataInterpretation(){return this.options.noDataInterpretation},setRenderingRule(t){this.options.renderingRule=t,this._update()},getRenderingRule(){return this.options.renderingRule},setMosaicRule(t){this.options.mosaicRule=t,this._update()},getMosaicRule(){return this.options.mosaicRule},_getPopupData(t){const i=e.Util.bind(function(i,s,o){i||setTimeout(e.Util.bind(function(){this._renderPopup(t.latlng,i,s,o)},this),300)},this),s=this.identify().at(t.latlng);this.options.mosaicRule&&s.setMosaicRule(this.options.mosaicRule),s.run(i),this._shouldRenderPopup=!0,this._lastClick=t.latlng},_buildExportParams(){const t=parseInt(this._map.options.crs.code.split(":")[1],10),e={bbox:this._calculateBbox(),size:this._calculateImageSize(),format:this.options.format,transparent:this.options.transparent,bboxSR:t,imageSR:t};return this.options.from&&this.options.to&&(e.time=`${this.options.from.valueOf()},${this.options.to.valueOf()}`),this.options.pixelType&&(e.pixelType=this.options.pixelType),this.options.interpolation&&(e.interpolation=this.options.interpolation),this.options.compressionQuality&&(e.compressionQuality=this.options.compressionQuality),this.options.bandIds&&(e.bandIds=this.options.bandIds),(0===this.options.noData||this.options.noData)&&(e.noData=this.options.noData),this.options.noDataInterpretation&&(e.noDataInterpretation=this.options.noDataInterpretation),this.service.options.token&&(e.token=this.service.options.token),this.options.renderingRule&&(e.renderingRule=JSON.stringify(this.options.renderingRule)),this.options.mosaicRule&&(e.mosaicRule=JSON.stringify(this.options.mosaicRule)),e},_requestExport(t,i){if("json"===this.options.f)this.service.request("exportImage",t,function(t,e){t||(this.options.token&&(e.href+=`?token=${this.options.token}`),this.options.proxy&&(e.href=`${this.options.proxy}?${e.href}`),this._renderImage(e.href,i))},this);else{t.f="image";let s=`${this.options.url}exportImage${e.Util.getParamString(t)}`;this.options.proxy&&(s=`${this.options.proxy}?${s}`),this._renderImage(s,i)}}});const vt=_t.extend({options:{updateInterval:150,layers:!1,layerDefs:!1,timeOptions:!1,format:"png32",transparent:!0,f:"json"},initialize(t){t=z(t),this.service=ht(t),this.service.addEventParent(this),e.Util.setOptions(this,t)},getDynamicLayers(){return this.options.dynamicLayers},setDynamicLayers(t){return this.options.dynamicLayers=t,this._update(),this},getLayers(){return this.options.layers},setLayers(t){return this.options.layers=t,this._update(),this},getLayerDefs(){return this.options.layerDefs},setLayerDefs(t){return this.options.layerDefs=t,this._update(),this},getTimeOptions(){return this.options.timeOptions},setTimeOptions(t){return this.options.timeOptions=t,this._update(),this},query(){return this.service.query()},identify(){return this.service.identify()},find(){return this.service.find()},_getPopupData(t){const i=e.Util.bind(function(i,s,o){i||setTimeout(e.Util.bind(function(){this._renderPopup(t.latlng,i,s,o)},this),300)},this);let s;if(s=this.options.popup?this.options.popup.on(this._map).at(t.latlng):this.identify().on(this._map).at(t.latlng),s.params.maxAllowableOffset||s.simplify(this._map,.5),this.options.popup&&this.options.popup.params&&this.options.popup.params.layers||(this.options.layers?s.layers(`visible:${this.options.layers.join(",")}`):s.layers("visible")),this.options.layerDefs&&"string"!=typeof this.options.layerDefs&&!s.params.layerDefs)for(const t in this.options.layerDefs)Object.hasOwn(this.options.layerDefs,t)&&s.layerDef(t,this.options.layerDefs[t]);s.run(i),this._shouldRenderPopup=!0,this._lastClick=t.latlng},_buildExportParams(){const t=parseInt(this._map.options.crs.code.split(":")[1],10),e={bbox:this._calculateBbox(),size:this._calculateImageSize(),dpi:96,format:this.options.format,transparent:this.options.transparent,bboxSR:t,imageSR:t};if(this.options.dynamicLayers&&(e.dynamicLayers=this.options.dynamicLayers),this.options.layers){if(0===this.options.layers.length)return;e.layers=`show:${this.options.layers.join(",")}`}return this.options.layerDefs&&(e.layerDefs="string"==typeof this.options.layerDefs?this.options.layerDefs:JSON.stringify(this.options.layerDefs)),this.options.timeOptions&&(e.timeOptions=JSON.stringify(this.options.timeOptions)),this.options.from&&this.options.to&&(e.time=`${this.options.from.valueOf()},${this.options.to.valueOf()}`),this.service.options.token&&(e.token=this.service.options.token),this.options.proxy&&(e.proxy=this.options.proxy),this.options.disableCache&&(e._ts=Date.now()),e},_requestExport(t,i){if("json"===this.options.f)this.service.request("export",t,function(t,e){t||(this.options.token&&e.href&&(e.href+=`?token=${this.options.token}`),this.options.proxy&&e.href&&(e.href=`${this.options.proxy}?${e.href}`),e.href?this._renderImage(e.href,i):this._renderImage(e.imageData,i,e.contentType))},this);else{t.f="image";let s=`${this.options.url}export${e.Util.getParamString(t)}`;this.options.proxy&&(s=`${this.options.proxy}?${s}`),this._renderImage(s,i)}}});const xt=e.Layer.extend({options:{cellSize:512,updateWhenIdle:e.Browser.mobile,updateInterval:150,noWrap:!1,keepBuffer:1.5},initialize(t){e.Util.setOptions(this,t)},onAdd(){this._cells={},this._activeCells={},this._resetView(),this._update()},onRemove(){this._removeAllCells(),this._cellZoom=void 0},isLoading(){return this._loading},redraw(){return this._map&&(this._removeAllCells(),this._update()),this},getEvents(){const t={viewprereset:this._invalidateAll,viewreset:this._resetView,zoom:this._resetView,moveend:this._onMoveEnd};return this.options.updateWhenIdle||(this._onMove||(this._onMove=e.Util.throttle(this._onMoveEnd,this.options.updateInterval,this)),t.move=this._onMove),t},createCell:()=>document.createElement("div"),removeCell(){},reuseCell(){},cellLeave(){},cellEnter(){},getCellSize(){const t=this.options.cellSize;return t instanceof e.Point?t:new e.Point(t,t)},_pruneCells(){if(!this._map)return;let t,e;for(t in this._cells)e=this._cells[t],e.retain=e.current;for(t in this._cells)if(e=this._cells[t],e.current&&!e.active){const t=e.coords;this._retainParent(t.x,t.y,t.z,t.z-5)||this._retainChildren(t.x,t.y,t.z,t.z+2)}for(t in this._cells)this._cells[t].retain||this._removeCell(t)},_removeAllCells(){for(const t in this._cells)this._removeCell(t)},_invalidateAll(){this._removeAllCells(),this._cellZoom=void 0},_retainParent(t,i,s,o){const r=Math.floor(t/2),n=Math.floor(i/2),a=s-1,l=new e.Point(+r,+n);l.z=+a;const h=this._cellCoordsToKey(l),p=this._cells[h];return p&&p.active?(p.retain=!0,!0):(p&&p.loaded&&(p.retain=!0),a>o&&this._retainParent(r,n,a,o))},_retainChildren(t,i,s,o){for(let r=2*t;r<2*t+2;r++)for(let t=2*i;t<2*i+2;t++){const i=new e.Point(r,t);i.z=s+1;const n=this._cellCoordsToKey(i),a=this._cells[n];a&&a.active?a.retain=!0:(a&&a.loaded&&(a.retain=!0),s+1<o&&this._retainChildren(r,t,s+1,o))}},_resetView(t){const e=t&&(t.pinch||t.flyTo);e||this._setView(this._map.getCenter(),this._map.getZoom(),e,e)},_setView(t,e,i,s){const o=Math.round(e);s||(this._cellZoom=o,this._abortLoading&&this._abortLoading(),this._resetGrid(),void 0!==o&&this._update(t),i||this._pruneCells(),this._noPrune=!!i)},_resetGrid(){const t=this._map,e=t.options.crs,i=this._cellSize=this.getCellSize(),s=this._cellZoom,o=this._map.getPixelWorldBounds(this._cellZoom);o&&(this._globalCellRange=this._pxBoundsToCellRange(o)),this._wrapX=e.wrapLng&&!this.options.noWrap&&[Math.floor(t.project([0,e.wrapLng[0]],s).x/i.x),Math.ceil(t.project([0,e.wrapLng[1]],s).x/i.y)],this._wrapY=e.wrapLat&&!this.options.noWrap&&[Math.floor(t.project([e.wrapLat[0],0],s).y/i.x),Math.ceil(t.project([e.wrapLat[1],0],s).y/i.y)]},_onMoveEnd(t){t&&(t.pinch||t.flyTo)||!this._map||this._map._animatingZoom||this._update()},_getCelldPixelBounds(t){const i=this._map,s=i._animatingZoom?Math.max(i._animateToZoom,i.getZoom()):i.getZoom(),o=i.getZoomScale(s,this._cellZoom),r=i.project(t,this._cellZoom).floor(),n=i.getSize().divideBy(2*o);return new e.Bounds(r.subtract(n),r.add(n))},_update(t){const i=this._map;if(!i)return;const s=Math.round(i.getZoom());void 0===t&&(t=i.getCenter());const o=this._getCelldPixelBounds(t),r=this._pxBoundsToCellRange(o),n=r.getCenter(),a=[],l=this.options.keepBuffer,h=new e.Bounds(r.getBottomLeft().subtract([l,-l]),r.getTopRight().add([l,-l]));if(!(isFinite(r.min.x)&&isFinite(r.min.y)&&isFinite(r.max.x)&&isFinite(r.max.y)))throw new Error("Attempted to load an infinite number of cells");for(const t in this._cells){const i=this._cells[t].coords;i.z===this._cellZoom&&h.contains(new e.Point(i.x,i.y))||(this._cells[t].current=!1)}if(Math.abs(s-this._cellZoom)>1)this._setView(t,s);else{for(let t=r.min.y;t<=r.max.y;t++)for(let i=r.min.x;i<=r.max.x;i++){const s=new e.Point(i,t);if(s.z=this._cellZoom,!this._isValidCell(s))continue;const o=this._cells[this._cellCoordsToKey(s)];o?o.current=!0:a.push(s)}if(a.sort((t,e)=>t.distanceTo(n)-e.distanceTo(n)),0!==a.length){this._loading||(this._loading=!0);for(let t=0;t<a.length;t++){const e=this._cellCoordsToKey(a[t]),i=this._keyToCellCoords(e);this._activeCells[i]?this._reuseCell(a[t]):this._createCell(a[t])}}}},_isValidCell(t){const i=this._map.options.crs;if(!i.infinite){const e=this._globalCellRange;if(!i.wrapLng&&(t.x<e.min.x||t.x>e.max.x)||!i.wrapLat&&(t.y<e.min.y||t.y>e.max.y))return!1}if(!this.options.bounds)return!0;const s=this._cellCoordsToBounds(t);return e.latLngBounds(this.options.bounds).overlaps(s)},_keyToBounds(t){return this._cellCoordsToBounds(this._keyToCellCoords(t))},_cellCoordsToNwSe(t){const e=this._map,i=this.getCellSize(),s=t.scaleBy(i),o=s.add(i);return[e.unproject(s,t.z),e.unproject(o,t.z)]},_cellCoordsToBounds(t){const i=this._cellCoordsToNwSe(t);let s=new e.LatLngBounds(i[0],i[1]);return this.options.noWrap||(s=this._map.wrapLatLngBounds(s)),s},_cellCoordsToKey:t=>`${t.x}:${t.y}:${t.z}`,_keyToCellCoords(t){const i=t.split(":"),s=new e.Point(+i[0],+i[1]);return s.z=+i[2],s},_removeCell(t){const e=this._cells[t];if(!e)return;const i=this._keyToCellCoords(t),s=this._wrapCoords(i),o=this._cellCoordsToBounds(this._wrapCoords(i));e.current=!1,delete this._cells[t],this._activeCells[t]=e,this.cellLeave(o,s,t),this.fire("cellleave",{key:t,coords:s,bounds:o})},_reuseCell(t){const e=this._cellCoordsToKey(t);this._cells[e]=this._activeCells[e],this._cells[e].current=!0;const i=this._wrapCoords(t),s=this._cellCoordsToBounds(this._wrapCoords(t));this.cellEnter(s,i,e),this.fire("cellenter",{key:e,coords:i,bounds:s})},_createCell(t){const i=this._cellCoordsToKey(t),s=this._wrapCoords(t),o=this._cellCoordsToBounds(this._wrapCoords(t));this.createCell(o,s,i),this.fire("cellcreate",{key:i,coords:s,bounds:o}),this._cells[i]={coords:t,current:!0},e.Util.requestAnimFrame(this._pruneCells,this)},_cellReady(t,e,i){const s=this._cellCoordsToKey(t);(i=this._cells[s])&&(i.loaded=+new Date,i.active=!0)},_getCellPos(t){return t.scaleBy(this.getCellSize())},_wrapCoords(t){const i=new e.Point(this._wrapX?e.Util.wrapNum(t.x,this._wrapX):t.x,this._wrapY?e.Util.wrapNum(t.y,this._wrapY):t.y);return i.z=t.z,i},_pxBoundsToCellRange(t){const i=this.getCellSize();return new e.Bounds(t.min.unscaleBy(i).floor(),t.max.unscaleBy(i).ceil().subtract([1,1]))}});function Lt(t){this.values=[].concat(t||[])}Lt.prototype.query=function(t){var e=this.getIndex(t);return this.values[e]},Lt.prototype.getIndex=function(t){this.dirty&&this.sort();for(var e,i,s=0,o=this.values.length-1;s<=o;)if(e=(s+o)/2|0,+(i=this.values[Math.round(e)]).value<+t)s=e+1;else{if(!(+i.value>+t))return e;o=e-1}return Math.abs(~o)},Lt.prototype.between=function(t,e){var i=this.getIndex(t),s=this.getIndex(e);if(0===i&&0===s)return[];for(;this.values[i-1]&&this.values[i-1].value===t;)i--;for(;this.values[s+1]&&this.values[s+1].value===e;)s++;return this.values[s]&&this.values[s].value===e&&this.values[s+1]&&s++,this.values.slice(i,s)},Lt.prototype.insert=function(t){return this.values.splice(this.getIndex(t.value),0,t),this},Lt.prototype.bulkAdd=function(t,e){return this.values=this.values.concat([].concat(t||[])),e?this.sort():this.dirty=!0,this},Lt.prototype.sort=function(){return this.values.sort(function(t,e){return+e.value-+t.value}).reverse(),this.dirty=!1,this};const St=xt.extend({options:{attribution:null,where:"1=1",fields:["*"],from:!1,to:!1,timeField:!1,timeFilterMode:"server",simplifyFactor:0,precision:6,fetchAllFeatures:!1},initialize(t){if(xt.prototype.initialize.call(this,t),t=z(t),t=e.Util.setOptions(this,t),this.service=dt(t),this.service.addEventParent(this),"*"!==this.options.fields[0]){let t=!1;for(let e=0;e<this.options.fields.length;e++)this.options.fields[e].match(/^(OBJECTID|FID|OID|ID)$/i)&&(t=!0);!1===t&&v("no known esriFieldTypeOID field detected in fields Array.  Please add an attribute field containing unique IDs to ensure the layer can be drawn correctly.")}this.options.timeField.start&&this.options.timeField.end?(this._startTimeIndex=new Lt,this._endTimeIndex=new Lt):this.options.timeField&&(this._timeIndex=new Lt),this._cache={},this._currentSnapshot=[],this._activeRequests=0},onAdd(t){return N(t),this.service.metadata(function(e,i){if(!e){const e=i.supportedQueryFormats;let s=!1;(!1===this.service.options.isModern||this.options.fetchAllFeatures)&&(s=!0),!s&&e&&-1!==e.indexOf("geoJSON")&&(this.service.options.isModern=!0),i.objectIdField&&(this.service.options.idAttribute=i.objectIdField),!this.options.attribution&&t.attributionControl&&i.copyrightText&&(this.options.attribution=i.copyrightText,t.attributionControl.addAttribution(this.getAttribution()))}},this),t.on("zoomend",this._handleZoomChange,this),xt.prototype.onAdd.call(this,t)},onRemove(t){return W(t),t.off("zoomend",this._handleZoomChange,this),xt.prototype.onRemove.call(this,t)},getAttribution(){return this.options.attribution},createCell(t,e){this._visibleZoom()&&this._requestFeatures(t,e)},_requestFeatures(t,i,s,o){this._activeRequests++,o=o||0;const r=this.options.where;return 1===this._activeRequests&&this.fire("loading",{bounds:t},!0),this._buildQuery(t,o).run(function(n,a,l){l&&l.exceededTransferLimit&&this.fire("drawlimitexceeded"),this.options.where===r&&(!n&&a&&a.features.length&&e.Util.requestAnimFrame(e.Util.bind(function(){this._addFeatures(a.features,i),this._postProcessFeatures(t)},this)),n||!a||a.features.length||this._postProcessFeatures(t),n&&this._postProcessFeatures(t),s&&s.call(this,n,a),l&&(l.exceededTransferLimit||l.properties&&l.properties.exceededTransferLimit)&&this.options.fetchAllFeatures&&this._requestFeatures(t,i,s,o+a.features.length))},this)},_postProcessFeatures(t){this._activeRequests--,this._activeRequests<=0&&this.fire("load",{bounds:t})},_cacheKey:t=>`${t.z}:${t.x}:${t.y}`,_addFeatures(t,e){let i;e&&(i=this._cacheKey(e),this._cache[i]=this._cache[i]||[]);for(let e=t.length-1;e>=0;e--){const s=t[e].id;-1===this._currentSnapshot.indexOf(s)&&this._currentSnapshot.push(s),void 0!==i&&-1===this._cache[i].indexOf(s)&&this._cache[i].push(s)}this.options.timeField&&this._buildTimeIndexes(t),this.createLayers(t)},_buildQuery(t,i){let s=this.service.query().intersects(t).where(this.options.where).fields(this.options.fields).precision(this.options.precision);return this.options.fetchAllFeatures&&!isNaN(parseInt(i))&&(s=s.offset(i)),s.params.resultType="tile",this.options.requestParams&&e.Util.extend(s.params,this.options.requestParams),this.options.simplifyFactor&&s.simplify(this._map,this.options.simplifyFactor),"server"===this.options.timeFilterMode&&this.options.from&&this.options.to&&s.between(this.options.from,this.options.to),s},setWhere(t,i,s){this.options.where=t&&t.length?t:"1=1";const o=[],r=[];let n=0,a=null;const l=e.Util.bind(function(l,h){if(l&&(a=l),h)for(let t=h.features.length-1;t>=0;t--)r.push(h.features[t].id);n--,n<=0&&this._visibleZoom()&&t===this.options.where&&(this._currentSnapshot=r,e.Util.requestAnimFrame(e.Util.bind(function(){this.removeLayers(o),this.addLayers(r),i&&i.call(s,a)},this)))},this);for(let t=this._currentSnapshot.length-1;t>=0;t--)o.push(this._currentSnapshot[t]);this._cache={};for(const t in this._cells){n++;const e=this._keyToCellCoords(t),i=this._cellCoordsToBounds(e);this._requestFeatures(i,e,l)}return this},getWhere(){return this.options.where},getTimeRange(){return[this.options.from,this.options.to]},setTimeRange(t,i,s,o){const r=this.options.from,n=this.options.to;let a=0,l=null;const h=e.Util.bind(function(e){e&&(l=e),this._filterExistingFeatures(r,n,t,i),a--,s&&a<=0&&s.call(o,l)},this);if(this.options.from=t,this.options.to=i,this._filterExistingFeatures(r,n,t,i),"server"===this.options.timeFilterMode)for(const t in this._cells){a++;const e=this._keyToCellCoords(t),i=this._cellCoordsToBounds(e);this._requestFeatures(i,e,h)}return this},refresh(){this.setWhere(this.options.where)},_filterExistingFeatures(t,i,s,o){const r=t&&i?this._getFeaturesInTimeRange(t,i):this._currentSnapshot,n=this._getFeaturesInTimeRange(s,o);if(n.indexOf)for(let t=0;t<n.length;t++){const e=r.indexOf(n[t]);e>=0&&r.splice(e,1)}e.Util.requestAnimFrame(e.Util.bind(function(){this.removeLayers(r),this.addLayers(n)},this))},_getFeaturesInTimeRange(t,e){const i=[];let s;if(this.options.timeField.start&&this.options.timeField.end){const i=this._startTimeIndex.between(t,e),o=this._endTimeIndex.between(t,e);s=i.concat(o)}else{if(!this._timeIndex)return v("You must set timeField in the layer constructor in order to manipulate the start and end time filter."),[];s=this._timeIndex.between(t,e)}for(let t=s.length-1;t>=0;t--)i.push(s[t].id);return i},_buildTimeIndexes(t){let e,i;if(this.options.timeField.start&&this.options.timeField.end){const s=[],o=[];for(e=t.length-1;e>=0;e--)i=t[e],s.push({id:i.id,value:new Date(i.properties[this.options.timeField.start])}),o.push({id:i.id,value:new Date(i.properties[this.options.timeField.end])});this._startTimeIndex.bulkAdd(s),this._endTimeIndex.bulkAdd(o)}else{const s=[];for(e=t.length-1;e>=0;e--)i=t[e],s.push({id:i.id,value:new Date(i.properties[this.options.timeField])});this._timeIndex.bulkAdd(s)}},_featureWithinTimeRange(t){if(!this.options.from||!this.options.to)return!0;const e=+this.options.from.valueOf(),i=+this.options.to.valueOf();if("string"==typeof this.options.timeField){const s=+t.properties[this.options.timeField];return s>=e&&s<=i}if(this.options.timeField.start&&this.options.timeField.end){const s=+t.properties[this.options.timeField.start],o=+t.properties[this.options.timeField.end];return s>=e&&s<=i||o>=e&&o<=i||s<=e&&o>=i}},_visibleZoom(){if(!this._map)return!1;const t=this._map.getZoom();return!(t>this.options.maxZoom||t<this.options.minZoom)},_handleZoomChange(){if(this._visibleZoom())for(const t in this._cells){const e=this._cells[t].coords,i=this._cacheKey(e);this._cache[i]&&this.addLayers(this._cache[i])}else this.removeLayers(this._currentSnapshot),this._currentSnapshot=[]},authenticate(t){return this.service.authenticate(t),this},metadata(t,e){return this.service.metadata(t,e),this},query(){return this.service.query()},_getMetadata(t){if(this._metadata){let e;t(e,this._metadata)}else this.metadata(e.Util.bind(function(e,i){this._metadata=i,t(e,this._metadata)},this))},addFeature(t,e,i){this.addFeatures(t,e,i)},addFeatures(t,i,s){this._getMetadata(e.Util.bind(function(o,r){if(o)return void(i&&i.call(this,o,null));const n=t.features?t.features:[t];this.service.addFeatures(t,e.Util.bind(function(t,e){if(!t){for(let t=n.length-1;t>=0;t--)n[t].properties[r.objectIdField]=n.length>1?e[t].objectId:e.objectId,n[t].id=n.length>1?e[t].objectId:e.objectId;this._addFeatures(n)}i&&i.call(s,t,e)},this))},this))},updateFeature(t,e,i){this.updateFeatures(t,e,i)},updateFeatures(t,e,i){const s=t.features?t.features:[t];this.service.updateFeatures(t,function(t,o){if(!t){for(let t=s.length-1;t>=0;t--)this.removeLayers([s[t].id],!0);this._addFeatures(s)}e&&e.call(i,t,o)},this)},deleteFeature(t,e,i){this.deleteFeatures(t,e,i)},deleteFeatures(t,e,i){return this.service.deleteFeatures(t,function(t,s){const o=s.length?s:[s];if(!t&&o.length>0)for(let t=o.length-1;t>=0;t--)this.removeLayers([o[t].objectId],!0);e&&e.call(i,t,s)},this)}}),At=St.extend({options:{cacheLayers:!0},initialize(t){t.apikey&&(t.token=t.apikey),St.prototype.initialize.call(this,t),this._originalStyle=this.options.style,this._layers={}},onRemove(t){for(const e in this._layers)t.removeLayer(this._layers[e]),this.fire("removefeature",{feature:this._layers[e].feature,permanent:!1},!0);return St.prototype.onRemove.call(this,t)},createNewLayer(t){const i=e.GeoJSON.geometryToLayer(t,this.options);return i&&(i.defaultOptions=i.options),i},_updateLayer(t,i){let s=[];const o=this.options.coordsToLatLng||e.GeoJSON.coordsToLatLng;switch(i.properties&&(t.feature.properties=i.properties),i.geometry.type){case"Point":s=e.GeoJSON.coordsToLatLng(i.geometry.coordinates),t.setLatLng(s);break;case"LineString":s=e.GeoJSON.coordsToLatLngs(i.geometry.coordinates,0,o),t.setLatLngs(s);break;case"MultiLineString":case"Polygon":s=e.GeoJSON.coordsToLatLngs(i.geometry.coordinates,1,o),t.setLatLngs(s);break;case"MultiPolygon":s=e.GeoJSON.coordsToLatLngs(i.geometry.coordinates,2,o),t.setLatLngs(s)}this.redraw(t.feature.id)},createLayers(t){for(let e=t.length-1;e>=0;e--){const i=t[e],s=this._layers[i.id];let o;!this._visibleZoom()||!s||this._map.hasLayer(s)||this.options.timeField&&!this._featureWithinTimeRange(i)||(this._map.addLayer(s),this.fire("addfeature",{feature:s.feature},!0)),s&&(s.setLatLngs||s.setLatLng)&&this._updateLayer(s,i),s||(o=this.createNewLayer(i),o?(o.feature=i,o.addEventParent(this),this.options.onEachFeature&&this.options.onEachFeature(o.feature,o),this._layers[o.feature.id]=o,this.setFeatureStyle(o.feature.id,this.options.style),this.fire("createfeature",{feature:o.feature},!0),this._visibleZoom()&&(!this.options.timeField||this.options.timeField&&this._featureWithinTimeRange(i))&&this._map.addLayer(o)):v("invalid GeoJSON encountered"))}},addLayers(t){for(let e=t.length-1;e>=0;e--){const i=this._layers[t[e]];!i||this.options.timeField&&!this._featureWithinTimeRange(i.feature)||(this._map.addLayer(i),this.fire("addfeature",{feature:i.feature},!0))}},removeLayers(t,e){for(let i=t.length-1;i>=0;i--){const s=t[i],o=this._layers[s];o&&(this.fire("removefeature",{feature:o.feature,permanent:e},!0),this._map.removeLayer(o)),o&&e&&delete this._layers[s]}},cellEnter(t,i){this._visibleZoom()&&!this._zooming&&this._map&&e.Util.requestAnimFrame(e.Util.bind(function(){const t=this._cacheKey(i),e=this._cellCoordsToKey(i),s=this._cache[t];this._activeCells[e]&&s&&this.addLayers(s)},this))},cellLeave(t,i){this._zooming||e.Util.requestAnimFrame(e.Util.bind(function(){if(this._map){const t=this._cacheKey(i),e=this._cellCoordsToKey(i),s=this._cache[t],o=this._map.getBounds();if(!this._activeCells[e]&&s){let i=!0;for(let t=0;t<s.length;t++){const e=this._layers[s[t]];e&&e.getBounds&&o.intersects(e.getBounds())&&(i=!1)}i&&this.removeLayers(s,!this.options.cacheLayers),!this.options.cacheLayers&&i&&(delete this._cache[t],delete this._cells[e],delete this._activeCells[e])}}},this))},resetStyle(){return this.options.style=this._originalStyle,this.eachFeature(function(t){this.resetFeatureStyle(t.feature.id)},this),this},setStyle(t){return this.options.style=t,this.eachFeature(function(e){this.setFeatureStyle(e.feature.id,t)},this),this},resetFeatureStyle(t){const i=this._layers[t],s=this._originalStyle||e.Path.prototype.options;return i&&(e.Util.extend(i.options,i.defaultOptions),this.setFeatureStyle(t,s)),this},setFeatureStyle(t,e){const i=this._layers[t];return"function"==typeof e&&(e=e(i.feature)),i.setStyle&&i.setStyle(e),this},eachActiveFeature(t,e){if(this._map){const i=this._map.getBounds();for(const s in this._layers)-1!==this._currentSnapshot.indexOf(this._layers[s].feature.id)&&("function"==typeof this._layers[s].getLatLng&&i.contains(this._layers[s].getLatLng())||"function"==typeof this._layers[s].getBounds&&i.intersects(this._layers[s].getBounds()))&&t.call(e,this._layers[s])}return this},eachFeature(t,e){for(const i in this._layers)t.call(e,this._layers[i]);return this},getFeature(t){return this._layers[t]},bringToBack(){this.eachFeature(t=>{t.bringToBack&&t.bringToBack()})},bringToFront(){this.eachFeature(t=>{t.bringToFront&&t.bringToFront()})},redraw(t){return t&&this._redraw(t),this},_redraw(t){const i=this._layers[t],s=i.feature;if(i&&i.setIcon&&this.options.pointToLayer&&this.options.pointToLayer){const t=this.options.pointToLayer(s,e.latLng(s.geometry.coordinates[1],s.geometry.coordinates[0])).options.icon;i.setIcon(t)}if(i&&i.setStyle&&this.options.pointToLayer){const t=this.options.pointToLayer(s,e.latLng(s.geometry.coordinates[1],s.geometry.coordinates[0])).options;this.setFeatureStyle(s.id,t)}i&&i.setStyle&&this.options.style&&this.resetFeatureStyle(s.id)},openPopup(t){return this._popup&&this._popup._prepareOpen(t||this._latlng)&&this._popup.openOn(this._map),this},openTooltip(t){return this._tooltip&&this._tooltip._prepareOpen(t)&&(this._tooltip.openOn(this._map),this.getElement?this._setAriaDescribedByOnLayer(this):this.eachLayer&&this.eachLayer(this._setAriaDescribedByOnLayer,this)),this}});var Tt={__proto__:null,VERSION:a,Support:p,options:u,Util:H,get:b,post:y,request:g,Task:K,task:function(t){return t=z(t),new K(t)},Query:X,query:Y,Find:tt,find:et,Identify:it,identify:function(t){return new it(t)},IdentifyFeatures:st,identifyFeatures:ot,IdentifyImage:rt,identifyImage:nt,Service:at,service:function(t){return t=z(t),new at(t)},MapService:lt,mapService:ht,ImageService:pt,imageService:ut,FeatureLayerService:ct,featureLayerService:dt,BasemapLayer:yt,basemapLayer:function(t,e){return new yt(t,e)},TiledMapLayer:ft,tiledMapLayer:function(t,e){return new ft(t,e)},RasterLayer:_t,ImageMapLayer:bt,imageMapLayer:function(t,e){return new bt(t,e)},DynamicMapLayer:vt,dynamicMapLayer:function(t,e){return new vt(t,e)},FeatureManager:St,FeatureLayer:At,featureLayer:function(t){return new At(t)}};class wt extends bt{initialize(t){var e,i,s,o;t.pane=null!==(e=t.pane)&&void 0!==e?e:"tilePane",this.options.id=null!==(i=this.options.id)&&void 0!==i?i:n.Util.createGuid(),this.options.pid=null!==(s=this.options.pid)&&void 0!==s?s:-1,this.options.show=null===(o=this.options.show)||void 0===o||o,super.initialize(t)}get isAdded(){return this._map&&this._map.hasLayer(this)}get pid(){return this.options.pid}set pid(t){this.options.pid=t}get id(){return this.options.id}set id(t){this.options.id=t}get name(){return this.options.name}set name(t){this.options.name=t}get opacity(){return this.options.opacity}set opacity(t){this.options.opacity=t,this.setOpacity(t)}get hasOpacity(){return!0}get bandIds(){return this.getBandIds()}set bandIds(t){this.setBandIds(t)}get show(){return this.options.show}set show(t){if(this.options.show!==t)if(this.options.show=t,t)this._map&&this.addTo(this._map);else{const t=this._map;this.remove(),this._map=t}}}n.layer.ArcGisImageLayer=wt,n.LayerUtil.register("arcgis_image",wt);class It extends ft{initialize(t){var e,i,s;super.initialize(t),this.options.id=null!==(e=this.options.id)&&void 0!==e?e:n.Util.createGuid(),this.options.pid=null!==(i=this.options.pid)&&void 0!==i?i:-1,this.options.show=null===(s=this.options.show)||void 0===s||s}get isAdded(){return this._map&&this._map.hasLayer(this)}get pid(){return this.options.pid}set pid(t){this.options.pid=t}get id(){return this.options.id}set id(t){this.options.id=t}get name(){return this.options.name}set name(t){this.options.name=t}get show(){return this.options.show}set show(t){if(this.options.show!==t)if(this.options.show=t,t)this._map&&this.addTo(this._map);else{const t=this._map;this.remove(),this._map=t}}get opacity(){return this.options.opacity}set opacity(t){this.options.opacity=t,this.setOpacity(t)}get hasOpacity(){return!0}getTileUrl(t){const e=this._getZoomForUrl(),i={s:this._getSubdomain(t),x:t.x,y:t.y,z:e};return r.default.Util.template(this.tileUrl,r.default.Util.extend(i,this.options))}}n.layer.ArcGisTileLayer=It,n.LayerUtil.register("arcgis_tile",It);class Ct extends vt{get isAdded(){return this._map&&this._map.hasLayer(this)}get pid(){return this.options.pid}set pid(t){this.options.pid=t}get id(){return this.options.id}set id(t){this.options.id=t}get name(){return this.options.name}set name(t){this.options.name=t}get opacity(){return this.options.opacity}set opacity(t){this.options.opacity=t,this.setOpacity(t)}get hasOpacity(){return!0}get show(){return this.options.show}set show(t){if(this.options.show!==t)if(this.options.show=t,t)this._map&&this.addTo(this._map);else{const t=this._map;this.remove(),this._map=t}}initialize(t){var e,i,s;let o;if(t.popup&&(o=t.popup,delete t.popup),t.pane=null!==(e=t.pane)&&void 0!==e?e:"tilePane",super.initialize(t),r.default.Util.stamp(this),this.options.id=null!==(i=this.options.id)&&void 0!==i?i:n.Util.createGuid(),this.options.pid=null!==(s=this.options.pid)&&void 0!==s?s:-1,o){const t=this.options.popupOptions||{};this.bindPopup((e,i,s)=>{if(null!=e&&e.code>0)return n.Util.msg(e.message),!1;const r=i.graphic;if(!r)return!1;const a=r.attr;let l=this.name;return t.noTitle?l=null:t.title?l=t.title:t.titleField&&(l=a[t.titleField]),n.Util.getTemplateHtml({title:l,template:o,attr:a})},{maxWidth:600})}}onAdd(t){super.onAdd(t),setTimeout(()=>{this._map&&!this._popup&&(this.highlight||this.listens("click"))&&(this._map.on("click",this._getPopupData,this),this._map.on("dblclick",this._resetPopupState,this))},1e3)}_renderPopup(t,e,i,s){var o;const r=null===(o=this.options)||void 0===o?void 0:o.highlight,a=n.Util.geoJsonToGraphics(i,{type:null==r?void 0:r.type,style:r}),l={layer:this,graphic:a.length>0?a[0]:null,graphics:a,geojson:i,latlng:t};this._popup&&super._renderPopup(t,e,l,s),a&&r&&(this._graphicLayer||(this._graphicLayer=new n.layer.GraphicLayer({name:"",isPrivate:!0}),this._map.addLayer(this._graphicLayer)),this._graphicLayer.clear(),this._graphicLayer.addGraphic(a),this._popup&&(this._popup._source=this,this.once(n.EventType.popupclose,t=>{this._graphicLayer.clear()}))),this.listens("click")&&this.fire(n.EventType.click,l)}}n.layer.ArcGisDynamicLayer=Ct,n.LayerUtil.register("arcgis_dynamic",Ct);class Ot extends At{get isAdded(){return this._map&&this._map.hasLayer(this)}get pid(){return this.options.pid}set pid(t){this.options.pid=t}get id(){return this.options.id}set id(t){this.options.id=t}get name(){return this.options.name}set name(t){this.options.name=t}get show(){return this.options.show}set show(t){if(this.options.show!==t)if(this.options.show=t,t)this._map&&this.addTo(this._map);else{const t=this._map;this.remove(),this._map=t}}get opacity(){return this.options.opacity}set opacity(t){this.options.opacity=t,this.setOpacity(t)}get hasOpacity(){return!0}initialize(t){var e,i,s;let o,a;if(t.popup&&(o=t.popup,delete t.popup),t.tooltip&&(a=t.tooltip,delete t.tooltip),super.initialize(function(t){var e;if(!t.symbol)return t;const i={...t};null!==(e=t.symbol)&&void 0!==e&&e.styleOptions&&(i.pointToLayer=function(e,i){const s=e.properties,o=function(t,e,i){if(!t)return{};let s={...t.styleOptions};if(t.styleField&&e){const i=e[t.styleField],o=t.styleFieldOptions[i];null!=o&&(s={...s,...o})}i&&s.iconUrlForSelect&&(s.iconUrl=s.iconUrlForSelect);if(s.hasOwnProperty("image"))t.icon=r.default.icon({iconUrl:s.image,...s});else if(s.hasOwnProperty("iconUrl"))t.icon=r.default.icon(s);else if(s.hasOwnProperty("iconFont")){let e=20;s.hasOwnProperty("iconSize")&&(e=s.iconSize[0]);const i=s.color||"#000000";s.className="",s.html='<i class="'+s.iconFont+'" style="color:'+i+";font-size:"+e+'px;"></i> ',t.icon=r.default.divIcon(s)}else{let i='<div class="centerat_animation" style="color:'+(s.color||"#0f89f5")+';"><p></p></div>';if(t.nameField){i+=' <div class="layer_divicon_name" style="top: 2px;left: 25px;" >'+e[t.nameField]+"</div>"}t.icon=r.default.divIcon({className:"",iconSize:[10,10],iconAnchor:[5,5],popupAnchor:[5,-5],tooltipAnchor:[5,-5],html:i})}return t}(t.symbol,s);return r.default.marker(i,o)},i.style=function(e){const i=e.properties,s=n.Util.getSymbolStyle(t.symbol,i);return n.PolygonStyleConver.toLeafletVal(s)},n.Util.defined(t.symbol.type)&&(n.GraphicUtil.isPointType(t.symbol.type)?delete i.style:delete i.pointToLayer));return i}(t)),r.default.Util.stamp(this),this.options.id=null!==(e=this.options.id)&&void 0!==e?e:n.Util.createGuid(),this.options.pid=null!==(i=this.options.pid)&&void 0!==i?i:-1,this.options.show=null===(s=this.options.show)||void 0===s||s,o){const t=this.options.popupOptions||{};this.bindPopup(e=>{var i;const s=null===(i=e.feature)||void 0===i?void 0:i.properties;if(!s)return"";let r=this.name;return t.noTitle?r=null:t.title?r=t.title:t.titleField&&(r=s[t.titleField]),n.Util.getTemplateHtml({title:r,template:o,attr:s})},{maxWidth:600})}if(a){const t=this.options.tooltipOptions||{};this.bindTooltip(e=>{var i;const s=null===(i=e.feature)||void 0===i?void 0:i.properties;if(!s)return"";let o=this.name;return t.noTitle?o=null:t.title?o=t.title:t.titleField&&(o=s[t.titleField]),n.Util.getTemplateHtml({title:o,template:a,attr:s})},{direction:"top"})}}createNewLayer(t){const e=super.createNewLayer(t);return e&&(e.parent=this),e}eachGraphic(t,e){return this.eachFeature(t,e)}getGraphicById(t){return this.getFeature(t)}setOpacity(t){0===t&&(t=.001),this.options.opacity=t;const e={opacity:this.options.opacity,fillOpacity:this.options.opacity};return this.eachGraphic(function(i){i.setOpacity?i.setOpacity(t):i.setStyle&&i.setStyle(e)},this),this}getBounds(){let t;return this.eachFeature(function(e){if(e.getBounds){var i;const s=e.getBounds();t=null!==(i=t)&&void 0!==i&&i._northEast?t.extend(s):s}else if(e.getLatLng){var s;const i=e.getLatLng();t=null!==(s=t)&&void 0!==s&&s._northEast?t.extend(i):r.default.latLngBounds(i,i)}},this),t}flyTo(t){if(this._map){const e=this.getBounds();null!=e&&e._northEast&&this._map.flyToBounds(e,t)}return this}}n.layer.ArcGisFeatureLayer=Ot,n.LayerUtil.register("arcgis_feature",Ot),r.default.esri=Tt,n.esri=Tt,n.Log.logInfo("mars2d-esri     3.3.6    2025-12-12 17:40"),t.ArcGisDynamicLayer=Ct,t.ArcGisFeatureLayer=Ot,t.ArcGisImageLayer=wt,t.ArcGisTileLayer=It,Object.defineProperty(t,"__esModule",{value:!0})});
